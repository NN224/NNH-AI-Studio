## مقدمة

هذه الخطة تهدف لإضافة طبقة **Brand‑Aware AI** على نظام الردود في تبويب Reviews، بحيث تصبح ردود الذكاء الاصطناعي واعية لهوية البراند لكل عميل (نبرة الصوت، نوع النشاط، السياسات)، مع الحفاظ على البساطة التقنية وإمكانية التوسع مستقبلاً.

## الأهداف الرئيسية

- **توحيد نبرة الصوت** في الردود لكل عميل/براند.
- **تقليل المخاطر** (عدم الوعد بأشياء غير مسموحة أو حساسة قانونياً).
- **جاهزية للوايت ليبل**: كل حساب/براند له إعدادات صوت خاصة، مع كود واحد مشترك.
- عدم كسر أية تدفقات حالية في:

`ReplyDialog`

`ReviewResponseCockpit`

`auto-reply`

## المرحلة 1 – نموذج بيانات بسيط للبراند

### 1.1 إضافة جدول brand_profiles

إنشاء جدول جديد في Supabase (أو استخدام جدول موجود إن وُجد شيء مشابه لاحقاً) مثلاً:

- **الاسم المقترح للجدول**  
  `brand_profiles`

- **أعمدة أساسية مقترحة (مستوى مبدئي)**:
  - `id`  
    UUID
  - `user_id`  
    يربط البراند بصاحب الحساب (أو نعدّل لاحقاً إلى `gmb_account_id` لو كان أوضح).
  - `display_name`  
    اسم البراند الظاهر في الـ prompts.
  - `business_type`  
    نوع النشاط (restaurant, clinic, salon, agency, ...).
  - `primary_language`  
    (ar, en, ar_en) لتحديد لغة الرد الأساسية.
  - `tone_style`  
    (friendly, formal, premium, playful, …).
  - `do_nots`  
    نص حر قصير يذكر ما يجب أن لا يقوله الـ AI (مثلاً: لا تذكر الأسعار، لا تقدّم وعود قانونية).
  - `always_include`  
    نقاط/عبارات مفضلة تُستخدم في نهاية الردود (مثلاً: “فريق عيادات … يشكركم”).
  - `example_replies`  
    نص JSON أو text يحتوي 2–3 أمثلة ردود تمثّل صوت البراند.
  - `created_at`, `updated_at`

### 1.2 ربط البراند بالحساب أو اللوكيشن

بدايةً نستخدم ربط بسيط:

- لكل `user_id` براند واحد افتراضي.  
- لاحقاً يمكن إضافة حقل:

`brand_profile_id`

إلى جدول:

`gmb_locations`

للسماح بإعدادات مختلفة لكل موقع.

## المرحلة 2 – تعديل مسارات الـ AI لحقن هوية البراند

### 2.1 مراجعة المسارات المستخدمة في تبويب Reviews

- مسارات أساسية حالياً:

`app/api/reviews/ai-response/route.ts`

`app/api/ai/generate-review-reply/route.ts`

`app/api/ai/generate/route.ts`

### 2.2 منطق مشترك قبل مناداة موديل الذكاء الاصطناعي

إضافة دالة مساعدة مشتركة في خدمة جديدة مثلاً:

`lib/services/brand-voice.ts`

وظيفتها:

1. استقبال  
   `user_id`  
   و (اختيارياً)  
   `location_id`.
2. قراءة `brand_profiles` (وأي ربط مع `gmb_locations` إن وجد).
3. بناء كائن يحتوي ملخّص صوت البراند:
   - `brand_name`
   - `business_type`
   - `primary_language`
   - `tone_style`
   - `do_nots`
   - `always_include`
   - `examples` (اختياري).

### 2.3 تعديل الـ prompts في المسارات

داخل:

`/api/reviews/ai-response`

`/api/ai/generate-review-reply`

يتم:

- استدعاء خدمة `brand-voice` لجلب ملخص البراند.
- حقن النص التالي في الـ system / user prompt قبل تفاصيل المراجعة:

> BRAND PROFILE  
> - Name: …  
> - Business type: …  
> - Primary language: …  
> - Tone style: …  
> - Do NOT: …  
> - Always include: …  
> - Example replies: … (مختصرة إن لزم)

مع الحفاظ على القواعد الحالية الخاصة بالتقييم (اعتذار للتقييمات المنخفضة، شكر للتقييمات العالية).

## المرحلة 3 – واجهة إعدادات بسيطة للبراند

### 3.1 صفحة/تبويب إعدادات

- إضافة تبويب أو قسم ضمن:

`/settings?tab=ai`

لتعديل:
  - اسم البراند الظاهر في الردود.  
  - نوع النشاط.  
  - اللغة الأساسية للردود.  
  - نبرة الصوت (اختيار من قائمة).  
  - نص “ممنوعات”.  
  - نص “دائماً أضف”.  
  - 2–3 أمثلة ردود (اختياري).

### 3.2 تجربة المستخدم

- حفظ الإعدادات مباشرة في جدول `brand_profiles`.  
- عرض معاينة سريعة لنص prompt مُركّب من هذه القيم، حتى يفهم المستخدم ماذا يرى الـ AI.  
- يمكن لاحقاً إضافة زر “تجربة رد” يرسل مراجعة تجريبية للـ AI ليتأكد العميل من النبرة.

## المرحلة 4 – التحقق والمخاطر

### 4.1 التحقق

- التأكد أن الردود:
  - تستخدم اسم البراند الصحيح.  
  - تحترم اللغة المحددة (ar / en / مختلط، حسب ما نقرّر لاحقاً).  
  - لا تخالف “do_nots” (قدر الإمكان ضمن قدرات الـ LLM).

- قياس:
  - نسبة الردود التي عدّلها المستخدم بعد اقتراح AI (تحفظ في `ai_generated_replies`).  
  - هل البراند الجديد يقلّل عدد التعديلات أم لا.

### 4.2 المخاطر

- الاعتماد على نصوص “do_nots” و “always_include” قد يطوّل الـ prompt → نحتاج مراقبة الطول.  
- يجب توحيد أسماء الحقول بين:

`gmb_reviews`

`brand_profiles`

`ai_generated_replies`

حتى لا يحدث تضارب.

## المرحلة 5 – مراحل التنفيذ المقترحة

1. **Phase 1 – Data Layer**
   - إنشاء جدول `brand_profiles`.  
   - إضافة type/interfaces في  
     `lib/types`  
     أو مكان مناسب.  
   - إعداد migration في مجلد  
     `supabase/migrations`.

2. **Phase 2 – Brand Voice Service**
   - إنشاء  
     `lib/services/brand-voice.ts`.  
   - دوال: `getBrandProfileForUser`, `getBrandProfileForLocation`, `buildBrandPromptSnippet`.

3. **Phase 3 – AI Routes Integration**
   - تعديل:

`app/api/reviews/ai-response/route.ts`

`app/api/ai/generate-review-reply/route.ts`

   - حقن `brandPromptSnippet` في الـ prompt قبل تفاصيل المراجعة.

4. **Phase 4 – Settings UI**
   - إضافة فورم إدارة البراند ضمن تبويب AI في الإعدادات.  
   - ربط الحقول مباشرة مع `brand_profiles`.

5. **Phase 5 – مراجعة وضبط**
   - اختبار على 2–3 أنواع أنشطة مختلفة (مطعم، عيادة، صالون).  
   - تعديل الـ prompts حسب النتائج الفعلية.  
   - توثيق السلوك في ملف دليل للمستخدمين النهائيين.

## ملاحظات ختامية

- هذه الخطة مصممة لتكون **minimal but extensible**:  
  نبدأ ببراند واحد لكل مستخدم، ثم نتوسع لاحقاً إلى براند لكل موقع أو لكل قناة.  
- التنفيذ يمكن أن يبدأ بعد إغلاق كل تبويبات الداشبورد الأساسية، بدون التأثير على تدفقات المراجعات الحالية.


